<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attraction</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- <link rel="stylesheet" href="/static/style.css" /> -->
    <link rel="stylesheet" href="/static/style2.css" />
  </head>
  <body>
    <div class="navigation">
      <div class="HeadContainer">
        <div class="LeftTitle">
          <div class="header-2-bold-30">
            <!-- 台北一日遊 -->
            <span class="BacktoIndex">台北一日遊</span>
          </div>
        </div>
        <div class="Frame2">
          <div class="Frame1">
            <div class="Itinerary">預定行程</div>
            <div class="Sign_In_Up" id="Sign_In_Up">
              <span class="login" id="login">登錄/註冊</span>
            </div>
            <div class="Sign_Out" id="Sign_Out" onclick="LogOutBtnPush()">
              登出系統
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation-placeholder"></div>
    <div class="divider"></div>

    <div class="attraction_itinerary">
      <div class="picture_current">
        <button class="control prev">
          <img src="/static/icon/LeftArror_Default.png" alt="Previous" />
        </button>
        <div class="slider">
          <div class="slide slide-1"></div>
          <div class="slide slide-2"></div>
          <div class="slide slide-3"></div>
        </div>
        <button class="control next">
          <img src="/static/icon/RightArror_Default.png" alt="Next" />
        </button>

        <div class="dots">
          <input type="radio" id="dot1" name="dot" />
          <input type="radio" id="dot2" name="dot" />
          <input type="radio" id="dot3" name="dot" />
        </div>
      </div>
      <div class="picture_profile">
        <div class="attractionName">景點</div>
        <div class="attractionCategory">景點分類</div>
        <div class="BookingForm">
          <div class="BookingFormText1">訂購導覽行程</div>
          <div class="BookingFormText2">
            以此景點為中心的一日行程，帶您探索城市角落故事
          </div>
          <div class="BookingDate">
            <div class="DateChoose">
              <div class="DateText">選擇日期 :&nbsp;</div>
              <input type="date" class="datecalendar" />
            </div>
          </div>
          <div class="selectTime">
            <div class="selectTimeText">選擇時間 :&nbsp;</div>
            <div class="radioButton-field">
              <div class="morning">
                <input
                  type="radio"
                  id="morning"
                  name="time"
                  value="morning"
                  checked
                  onclick="updateFee()"
                />
                <label for="morning">上半天</label>
              </div>
              <div class="afternoon">
                <input
                  type="radio"
                  id="afternoon"
                  name="time"
                  value="afternoon"
                  onclick="updateFee()"
                />
                <label for="afternoon">下半天</label>
              </div>
            </div>
          </div>

          <div class="tour_fee">
            <div class="tour_fee_text">導覽費用:&nbsp;</div>
            <div class="tour_fee_dollars">
              新台幣<span class="tour_fee_amount">2000</span>元
            </div>
          </div>
          <div class="submitButtonBookingForm">
            <button class="BookingForm-button">開始預約行程</button>
          </div>
        </div>
      </div>
    </div>

    <div class="divider2"></div>

    <div class="sectionInfo">
      <div class="AttractionInfO">
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Enim, aperiam
        ipsum ipsa veniam rem temporibus et, pariatur explicabo consequuntur
        dolore, aut incidunt deserunt nam magnam nihil animi. Quis perspiciatis
        reiciendis voluptatem minus, provident dicta et id iusto delectus
        officiis adipisci similique tempora dignissimos possimus? Magni
        distinctio accusamus esse qui deserunt quasi officiis vitae unde nemo, u
      </div>
      <div class="address">
        <div class="attractionAddressTitle">景點地址:</div>
        <div class="attractionAddress">臺北市 大安區忠孝東路4段</div>
      </div>
      <div class="traffic">
        <div class="trafficWay">交通方式:</div>
        <div class="trafficInfo">
          捷運站名：忠孝復興站4號出口1.公車：204、212、212直、232、232副、262、262(區間)、278、299、521、605、605(副)、605(新台五線)、667、903、忠孝新幹線至頂好市場站
          2.車位：太平洋崇光百貨地下停車場或市民大道附近地下停車場
        </div>
      </div>
    </div>
    <div class="footerextend"></div>
    <div class="footer">
      <div class="footerText">COPYRIGHT © 2021 台北一日遊</div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="LoginInForm" class="LoginInForm">
      <div class="LoginBar"></div>
      <div class="LoginClosebox" id="LogincloseBtn">
        <img src="/static/icon/LoginClose.png" alt="closed" />
      </div>
      <div class="loginMemberMain">
        <div class="loginMemberText">登入會員帳號</div>
        <input
          type="text"
          class="MemberEmail"
          placeholder="輸入電子信箱"
          id="MemberEmail"
        />
        <input
          type="password"
          class="MemberPassword"
          placeholder="輸入密碼"
          id="MemberPassword"
        />
        <button class="LoginButton" onclick="LoginFetch()">登入帳戶</button>
        <div class="LoginMsgText" id="LoginMsgText"></div>
        <div class="WithoutAccountText">
          還沒有帳戶?<span id="SwitchToRegister" class="SwitchToRegister"
            >點此註冊</span
          >
        </div>
      </div>
    </div>

    <div id="registerForm" class="registerForm">
      <div class="LoginBar"></div>
      <div class="RegistercloseBtn" id="RegistercloseBtn">
        <img src="/static/icon/LoginClose.png" alt="closed" />
      </div>
      <div class="loginMemberMain">
        <div class="loginMemberText">註冊會員帳號</div>
        <input
          type="text"
          class="AccountName"
          placeholder="輸入姓名"
          id="RegistAccountName"
        />
        <input
          type="text"
          class="MemberEmail"
          placeholder="輸入電子信箱"
          id="RegistMemberEmail"
        />
        <input
          type="password"
          class="MemberPassword"
          placeholder="輸入密碼"
          id="RegistMemberPassword"
        />
        <button class="LoginButton" onclick="RegisterFetch()">
          註冊新帳戶
        </button>
        <div class="MsgText" id="MsgText">已經註冊帳戶</div>
        <div class="WithoutAccountText">
          已經有帳戶?<span id="SwitchToLogin" class="SwitchToLogin"
            >點此登入</span
          >
        </div>
      </div>
    </div>

    <script>
      let slider;
      let slides;
      let prevButton;
      let nextButton;
      let dots;
      let currentIndex = 0;

      window.addEventListener("DOMContentLoaded", function () {
        slider = document.querySelector(".slider");
        slides = document.querySelectorAll(".slide");
        prevButton = document.querySelector(".prev");
        nextButton = document.querySelector(".next");

        LoginTextSwitch();
        LoginRegistActive();
        SwitchToRegister();
        SwitchToLogin();

        // 初始化 dots 容器
        var dotsContainer = document.querySelector(".dots");
        console.log("DOM fully loaded and parsed");

        // 清空 slider 和 dots 容器
        slider.innerHTML = "";
        dotsContainer.innerHTML = "";

        prevButton.addEventListener("click", () => {
          showSlide(currentIndex - 1);
        });

        nextButton.addEventListener("click", () => {
          showSlide(currentIndex + 1);
        });

        fetchAttraction().then(() => {
          // 更新 dots 在 fetchAttraction 完成後
          dots = document.querySelectorAll(".dots input[type='radio']");
          updateDots();

          // Optional: Auto-slide
          setInterval(() => {
            showSlide(currentIndex + 1);
          }, 3000);
        });

        updateFee();

        //回到首頁
        document
          .querySelector(".BacktoIndex")
          .addEventListener("click", function () {
            window.location.href = `/`;
          });
      });

      //////////////////////////////分隔線//////////////////////////////////////////

      //右上登入註冊按鈕按下RegistercloseBtn
      function LoginRegistActive() {
        var loginBtn = document.getElementById("login");
        var LoginInmodal = document.getElementById("LoginInForm");
        var Registermodal = document.getElementById("registerForm");
        var overlay = document.getElementById("overlay");
        var LoginccloseBtn = document.getElementById("LogincloseBtn");
        var RegistercloseBtn = document.getElementById("RegistercloseBtn");

        loginBtn.addEventListener("click", function () {
          LoginInmodal.style.display = "block";
          overlay.style.display = "block";
          document.getElementById("LoginMsgText").innerText = "";
          document.getElementById("LoginMsgText").style.display = "none";
        });

        LoginccloseBtn.addEventListener("click", function () {
          LoginInmodal.style.display = "none";
          overlay.style.display = "none";
          document.getElementById("LoginMsgText").innerText = "";
          document.getElementById("LoginMsgText").style.display = "none";
        });

        RegistercloseBtn.addEventListener("click", function () {
          Registermodal.style.display = "none";
          overlay.style.display = "none";
          document.getElementById("MsgText").innerText = "";
          document.getElementById("MsgText").style.display = "none";
        });

        overlay.addEventListener("click", function () {
          LoginInmodal.style.display = "none";
          Registermodal.style.display = "none";
          overlay.style.display = "none";
        });
      }

      //切換到註冊面板
      function SwitchToRegister() {
        let SwitchToRegister = document.getElementById("SwitchToRegister");
        let LoginInmodal = document.getElementById("LoginInForm");
        let Registermodal = document.getElementById("registerForm");
        SwitchToRegister.addEventListener("click", function () {
          Registermodal.style.display = "block";
          LoginInmodal.style.display = "none";
          document.getElementById("MsgText").innerText = "";
          document.getElementById("MsgText").style.display = "none";
        });
      }
      //切換到登入面板
      function SwitchToLogin() {
        let SwitchToLogin = document.getElementById("SwitchToLogin");
        let LoginInmodal = document.getElementById("LoginInForm");
        let Registermodal = document.getElementById("registerForm");
        SwitchToLogin.addEventListener("click", function () {
          Registermodal.style.display = "none";
          LoginInmodal.style.display = "block";
          document.getElementById("LoginMsgText").innerText = "";
          document.getElementById("LoginMsgText").style.display = "none";
        });
      }

      //按下註冊面板下的註冊紐發送註冊資料
      async function RegisterFetch() {
        var username = document.getElementById("RegistAccountName").value;
        var email = document.getElementById("RegistMemberEmail").value;
        var password = document.getElementById("RegistMemberPassword").value;
        if (!email || !password || !username) {
          window.alert("請填寫完整的個人資料");
          return; // 如果有未填寫的字段，停止執行後續程式碼
        }

        const userData = {
          username: username,
          email: email,
          password: password,
        };

        try {
          // const response = await fetch("/signup", {
          const response = await fetch("/api/user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          const responseMessage = await response.json();
          const msgText = document.getElementById("MsgText");

          if (!response.ok) {
            if (response.status === 400) {
              msgText.innerText = responseMessage.message;
              msgText.style.display = "flex";
              msgText.style.color = "red";
            } else {
              msgText.style.display = "none";
              msgText.innerText = "";
            }
          } else {
            if (response.status === 200) {
              msgText.innerText = "註冊成功，請登入系統";
              msgText.style.display = "flex";
              msgText.style.color = "green";
            }
          }

          // const user = await response.json();
          // console.log("User created:", user);
        } catch (error) {
          console.error("Error:", error.message);
          // 在這裡處理錯誤，顯示錯誤訊息於console
        }
      }

      //按下登錄面板下的登錄紐發送登錄資料
      async function LoginFetch() {
        try {
          // 獲取登入用戶的資料
          var email = document.getElementById("MemberEmail").value;
          var password = document.getElementById("MemberPassword").value;

          if (!email || !password) {
            window.alert("請填寫完整的電子郵件和密碼");
            return; // 如果有未填寫的字段，停止執行後續程式碼
          }

          // 準備發送數據
          var formData = new URLSearchParams();
          formData.append("username", email);
          formData.append("password", password);

          // 發送post請求
          // var response = await fetch("/token", {
          var response = await fetch("/api/user/auth", {
            // method: "POST",
            method: "PUT",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: formData.toString(),
          });

          var data = await response.json();

          if (!response.ok) {
            if (response.status === 400) {
              document.getElementById("LoginMsgText").style.display = "flex";
              document.getElementById("LoginMsgText").innerText = data.message;

              document.getElementById("LoginMsgText").style.color = "red";
              console.log(data.message);
            }
          } else {
            console.log(data);
            // 將token存儲到localStorage
            // localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("access_token", data.token);
            window.location.href = window.location.href;
          }
        } catch (error) {
          console.error("Error:", error.message);
        }
      }

      //登錄狀態檢查
      async function CheckingLoginStatus() {
        let token = localStorage.getItem("access_token");
        // console.log(token);
        if (!token) {
          console.error("No token found");
          return false;
        }
        try {
          // let response = await fetch("/LoginStatus", {
          let response = await fetch("/api/user/auth", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          let data = await response.json();
          if (!response.ok) {
            throw new Error("未能獲取數據");
          }

          console.log(data);
          return true;
        } catch (error) {
          console.error("Error:", error.message);
          return False;
        }
      }

      //置換右上角登入時候的狀態
      async function LoginTextSwitch() {
        let isLoggedIn = await CheckingLoginStatus();

        let Sign_Out = document.getElementById("Sign_Out");
        let Sign_In_Up = document.getElementById("Sign_In_Up");

        if (isLoggedIn) {
          // 用戶已登錄，置換右上角登錄文字為"登出系統"
          Sign_In_Up.style.display = "none";
          Sign_Out.style.display = "flex";
        } else {
          // 用戶未登錄，置換右上角登錄文字為"登入/註冊"
          Sign_In_Up.style.display = "flex";
          Sign_Out.style.display = "none";
        }
      }

      //刪除jwt登錄toekn
      function LogOutDeleteToken() {
        localStorage.removeItem("access_token");
      }

      //按下右上角登出鈕，置換右上角登錄文字為"登入/註冊"
      async function LogOutBtnPush() {
        LogOutDeleteToken();
        LoginTextSwitch();
      }

      //////////////////////////////分隔線////////////////////////////////////

      const urlSegments = window.location.pathname.split("/");
      const attractionId = urlSegments[urlSegments.length - 1];

      async function fetchAttraction() {
        try {
          const response = await fetch(`/api/attraction/${attractionId}`);
          const data = await response.json();
          const attractionNameContent = data["data"]["name"];
          const attractionCATContent = data["data"]["category"];
          const attractionInfo = data["data"]["description"];
          const attractionAddress = data["data"]["address"];
          const attractionTransport = data["data"]["transport"];
          const attractionImg = data["data"]["images"];

          document.querySelector(".attractionName").textContent =
            attractionNameContent;
          document.querySelector(".attractionCategory").textContent =
            attractionCATContent;
          document.querySelector(".AttractionInfO").textContent =
            attractionInfo;
          document.querySelector(".attractionAddress").textContent =
            attractionAddress;
          document.querySelector(".trafficInfo").textContent =
            attractionTransport;

          // 清空 slider 和 dots 容器
          slider.innerHTML = "";
          var dotsContainer = document.querySelector(".dots");
          dotsContainer.innerHTML = "";

          for (let i = 0; i < attractionImg.length; i++) {
            var sliderbox = document.createElement("div");
            var inputDot = document.createElement("input");
            sliderbox.classList.add("slide");
            sliderbox.style.backgroundImage = `url(${attractionImg[i]})`;
            slider.appendChild(sliderbox);

            inputDot.setAttribute("type", "radio");
            inputDot.setAttribute("name", "dot");
            if (i === currentIndex) {
              inputDot.checked = true;
            }
            inputDot.addEventListener("click", () => {
              showSlide(i);
            });
            dotsContainer.appendChild(inputDot);
          }

          // 更新 slides 和 dots
          slides = document.querySelectorAll(".slide");
        } catch (error) {
          console.error("problem with fetch operation:", error);
        }
      }

      function showSlide(index) {
        if (index >= slides.length) {
          currentIndex = 0;
        } else if (index < 0) {
          currentIndex = slides.length - 1;
        } else {
          currentIndex = index;
        }
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        updateDots();
      }

      function updateDots() {
        dots.forEach((dot, index) => {
          dot.checked = index === currentIndex;
        }); //如果 index 和 currentIndex 相等，那麼 dot.checked 被設置為 true，否則設置為 false
      }

      function updateFee() {
        const morningFee = 2000;
        const afternoonFee = 2500;
        const feeElement = document.querySelector(".tour_fee_amount");

        if (document.getElementById("morning").checked) {
          feeElement.textContent = morningFee;
        } else if (document.getElementById("afternoon").checked) {
          feeElement.textContent = afternoonFee;
        }
      }
    </script>
  </body>
</html>
